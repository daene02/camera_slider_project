{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="container">
    <h2 class="text-xlarge">Focus Point Control</h2>
    
    <div class="focus-controls">
        <div class="row">
            <div class="col-md-6">
                <input type="text" id="point-name" class="form-control mb-2" placeholder="Point Name">
                <div class="input-group mb-2">
                    <input type="number" id="x-pos" class="form-control" placeholder="X">
                    <input type="number" id="y-pos" class="form-control" placeholder="Y">
                    <input type="number" id="z-pos" class="form-control" placeholder="Z">
                </div>
                <div class="flex mb-2">
                    <input type="color" id="point-color" class="form-control" value="#4a9eff">
                    <button id="savePoint" class="btn btn-primary ml-2">Save</button>
                </div>
                <div class="btn-group w-100">
                    <button id="startTracking" class="btn btn-success">Start</button>
                    <button id="stopTracking" class="btn btn-danger" disabled>Stop</button>
                </div>
                <div class="text-center mt-3">
                    <button id="recordButton" class="icon-button record-button">
                        <i class="fas fa-circle"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="points-list" id="pointsList"></div>
            </div>
        </div>
    </div>
    
    <div class="text-right mt-3">
        <a href="/focus/visualization" target="_blank" class="btn btn-secondary">
            3D Visualization
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const saveButton = document.getElementById('savePoint');
    const startButton = document.getElementById('startTracking');
    const stopButton = document.getElementById('stopTracking');
    const pointNameInput = document.getElementById('point-name');
    const pointColorInput = document.getElementById('point-color');
    const xInput = document.getElementById('x-pos');
    const yInput = document.getElementById('y-pos');
    const zInput = document.getElementById('z-pos');
    const pointsList = document.getElementById('pointsList');

    let currentPointId = null;
    let savedPoints = [];

    let isRecording = false;
    const recordButton = document.getElementById('recordButton');

    recordButton.addEventListener('click', async () => {
        try {
            const action = isRecording ? 'stop' : 'start';
            const response = await fetch(`/camera/${action}_recording`, { method: 'POST' });
            
            if (response.ok) {
                isRecording = !isRecording;
                recordButton.classList.toggle('recording', isRecording);
            } else {
                throw new Error(`Failed to ${action} recording`);
            }
        } catch (error) {
            console.error('Recording error:', error);
            alert(error.message);
        }
    });

    async function loadFocusPoints() {
        try {
            const response = await fetch('/focus/points');
            savedPoints = await response.json();
            renderPointsList();
        } catch (error) {
            console.error('Error loading points:', error);
        }
    }

    function renderPointsList() {
        pointsList.innerHTML = savedPoints.map(point => `
            <div class="point-card">
                <div>
                    <strong>${point.name}</strong>
                    <div>X: ${point.x}, Y: ${point.y}, Z: ${point.z}</div>
                </div>
                <div>
                    <input type="color" value="${point.color}" disabled>
                    <button onclick="usePoint(${point.id})" class="btn btn-sm btn-primary">Use</button>
                    <button onclick="deletePoint(${point.id})" class="btn btn-sm btn-danger">Ã—</button>
                </div>
            </div>
        `).join('');
    }

    window.usePoint = async function(pointId) {
        try {
            const response = await fetch(`/focus/point/${pointId}`);
            const point = await response.json();
            pointNameInput.value = point.name;
            xInput.value = point.x;
            yInput.value = point.y;
            zInput.value = point.z;
            pointColorInput.value = point.color;
        } catch (error) {
            console.error('Error:', error);
        }
    };

    window.deletePoint = async function(pointId) {
        if (pointId === undefined || pointId === null) {
            console.error('Invalid point ID');
            return;
        }

        try {
            const response = await fetch(`/focus/point/${pointId}`, { 
                method: 'DELETE'
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete point');
            }

            await loadFocusPoints();
        } catch (error) {
            console.error('Error:', error);
            alert(error.message || 'Failed to delete point');
        }
    };

    saveButton.addEventListener('click', async () => {
        const pointData = {
            name: pointNameInput.value || `Point ${Date.now()}`,
            color: pointColorInput.value,
            x: parseFloat(xInput.value),
            y: parseFloat(yInput.value),
            z: parseFloat(zInput.value)
        };

        try {
            await fetch('/focus/save_point', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pointData)
            });
            
            await loadFocusPoints();
            pointNameInput.value = '';
            xInput.value = '';
            yInput.value = '';
            zInput.value = '';
        } catch (error) {
            console.error('Error:', error);
        }
    });

    startButton.addEventListener('click', async () => {
        const point = {
            x: parseFloat(xInput.value),
            y: parseFloat(yInput.value),
            z: parseFloat(zInput.value)
        };

        try {
            await fetch('/focus/start_tracking', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(point)
            });

            startButton.disabled = true;
            stopButton.disabled = false;
        } catch (error) {
            console.error('Error:', error);
        }
    });

    stopButton.addEventListener('click', async () => {
        try {
            await fetch('/focus/stop_tracking', { method: 'POST' });
            startButton.disabled = false;
            stopButton.disabled = true;
        } catch (error) {
            console.error('Error:', error);
        }
    });

    loadFocusPoints();
});
</script>
{% endblock %}
