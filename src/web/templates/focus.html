{% extends "base.html" %}

{% block title %}Focus Control{% endblock %}

{% block content %}
<div class="control-section">
    <h1>Focus Control</h1>
    
    <div class="focus-control-panel">
        <div class="visualization-panel">
            <h2>Focus Point Visualization</h2>
            <div class="visualization-container">
                <canvas id="focusVisualization"></canvas>
                <div class="axis-labels">
                    <span class="x-axis">X Axis</span>
                    <span class="y-axis">Y Axis</span>
                    <span class="z-axis">Z Axis</span>
                </div>
            </div>
        </div>
        
        <div class="tracking-setup">
            <h2>Profile Selection</h2>
            <div class="setting-row">
                <label>Focus Profile:</label>
                <select id="focus-profile" class="form-control">
                    <option value="">Select a profile...</option>
                </select>
                <button id="loadProfile" class="btn">Load Profile</button>
            </div>

            <h2>Focus Point Settings</h2>
            <div class="coordinates">
                <div class="coordinate-input">
                    <label>X Position (mm):</label>
                    <input type="number" id="x-pos" value="400" class="form-control">
                </div>
                <div class="coordinate-input">
                    <label>Y Position (mm):</label>
                    <input type="number" id="y-pos" value="600" class="form-control">
                </div>
                <div class="coordinate-input">
                    <label>Z Position (mm):</label>
                    <input type="number" id="z-pos" value="-300" class="form-control">
                </div>
            </div>

            <div class="action-buttons">
                <button id="startTracking" class="btn">Start Tracking</button>
                <button id="stopTracking" class="btn danger" disabled>Stop Tracking</button>
                <button id="savePoint" class="btn">Save Point</button>
            </div>
        </div>

        <div class="saved-points">
            <h2>Saved Focus Points</h2>
            <div id="pointsList"></div>
        </div>
    </div>
</div>

<style>
.visualization-panel {
    background: rgba(0, 0, 0, 0.4);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.visualization-container {
    position: relative;
    width: 100%;
    height: 300px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
    margin: 10px 0;
    overflow: hidden;
}

#focusVisualization {
    width: 100%;
    height: 100%;
}

.axis-labels {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    pointer-events: none;
}

.axis-labels span {
    position: absolute;
    color: rgba(255, 255, 255, 0.7);
    font-size: 12px;
}

.x-axis {
    bottom: 5px;
    right: 5px;
}

.y-axis {
    top: 5px;
    right: 5px;
}

.z-axis {
    top: 5px;
    left: 5px;
}

.control-section {
    padding: 20px;
}

.focus-control-panel {
    padding: 20px;
    background: rgba(0, 0, 0, 0.6);
    border-radius: 8px;
    margin: 20px 0;
    backdrop-filter: blur(5px);
}

.tracking-setup, .saved-points {
    background: rgba(0, 0, 0, 0.4);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.setting-row {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.setting-row label {
    min-width: 120px;
    font-weight: bold;
    color: white;
}

.form-control {
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
    color: white;
    font-size: 14px;
    min-width: 200px;
}

.form-control:focus {
    outline: none;
    border-color: rgba(255,255,255,0.5);
    background: rgba(255,255,255,0.15);
}

.coordinates {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.coordinate-input {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.coordinate-input label {
    color: white;
    font-weight: bold;
}

.coordinate-input input {
    padding: 8px;
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(255,255,255,0.1);
    color: white;
}

.action-buttons {
    display: flex;
    gap: 10px;
    margin: 20px 0;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    background: rgba(255,255,255,0.1);
    color: white;
    transition: all 0.3s ease;
    min-width: 120px;
    font-weight: bold;
}

.btn:hover {
    background: rgba(255,255,255,0.2);
    transform: scale(1.05);
}

.btn.danger {
    background: rgba(255,0,0,0.3);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.saved-points {
    margin-top: 30px;
}

#pointsList {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.point-card {
    background: rgba(255,255,255,0.1);
    padding: 15px;
    border-radius: 4px;
    position: relative;
    backdrop-filter: blur(5px);
    transition: all 0.3s ease;
}

.point-card:hover {
    background: rgba(255,255,255,0.15);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.point-card h3 {
    margin: 0 0 10px 0;
    color: white;
}

.point-card .coordinates {
    font-size: 0.9em;
    margin: 5px 0;
    color: rgba(255,255,255,0.9);
}

.point-card button {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 5px;
    background: rgba(255,0,0,0.3);
    border: none;
    border-radius: 3px;
    cursor: pointer;
    color: white;
}

h1, h2 {
    color: white;
    margin-bottom: 20px;
}

h2 {
    font-size: 1.5em;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    padding-bottom: 10px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById('focusVisualization');
    const ctx = canvas.getContext('2d');
    let animationFrameId;

    function resizeCanvas() {
        const container = canvas.parentElement;
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
    }

    function drawPoint(x, y, z) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Convert 3D coordinates to 2D visualization
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const scale = 0.2;  // Scale factor to fit within canvas
        
        // Simple isometric projection
        const isoX = centerX + (x - y) * scale;
        const isoY = centerY + ((x + y) * scale / 2 - z * scale);
        
        // Draw target point
        ctx.beginPath();
        ctx.arc(isoX, isoY, 5, 0, Math.PI * 2);
        ctx.fillStyle = 'red';
        ctx.fill();
        
        // Draw guidelines
        ctx.beginPath();
        ctx.moveTo(isoX, isoY);
        ctx.lineTo(isoX, canvas.height - 10);  // Vertical line to ground
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.stroke();
        
        // Draw axis indicators
        ctx.font = '12px Arial';
        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
        ctx.fillText(`X: ${x}mm`, 10, 20);
        ctx.fillText(`Y: ${y}mm`, 10, 40);
        ctx.fillText(`Z: ${z}mm`, 10, 60);
    }

    function updateVisualization() {
        const x = parseFloat(xInput.value);
        const y = parseFloat(yInput.value);
        const z = parseFloat(zInput.value);
        
        if (!isNaN(x) && !isNaN(y) && !isNaN(z)) {
            drawPoint(x, y, z);
        }
        
        animationFrameId = requestAnimationFrame(updateVisualization);
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    updateVisualization();

    const startButton = document.getElementById('startTracking');
    const stopButton = document.getElementById('stopTracking');
    const saveButton = document.getElementById('savePoint');
    const loadProfileButton = document.getElementById('loadProfile');
    const xInput = document.getElementById('x-pos');
    const yInput = document.getElementById('y-pos');
    const zInput = document.getElementById('z-pos');
    const pointsList = document.getElementById('pointsList');
    const profileSelect = document.getElementById('focus-profile');

    function loadProfiles() {
        fetch('/profile/list')
            .then(response => response.json())
            .then(profiles => {
                profileSelect.innerHTML = '<option value="">Select a profile...</option>';
                profiles.forEach(profile => {
                    const option = document.createElement('option');
                    option.value = profile;
                    option.textContent = profile;
                    profileSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading profiles:', error);
                alert('Failed to load profiles');
            });
    }

    function getFocusPoint() {
        const x = parseFloat(xInput.value);
        const y = parseFloat(yInput.value);
        const z = parseFloat(zInput.value);

        if (isNaN(x) || isNaN(y) || isNaN(z)) {
            throw new Error('Invalid coordinate values');
        }

        return { x, y, z };
    }

    function updateButtonStates(tracking) {
        startButton.disabled = tracking;
        stopButton.disabled = !tracking;
        saveButton.disabled = tracking;
        loadProfileButton.disabled = tracking;
        profileSelect.disabled = tracking;
    }

    function saveToLocalStorage() {
        const settings = {
            x: xInput.value,
            y: yInput.value,
            z: zInput.value,
            profile: profileSelect.value
        };
        localStorage.setItem('focusSettings', JSON.stringify(settings));
    }

    function loadFromLocalStorage() {
        const settings = JSON.parse(localStorage.getItem('focusSettings'));
        if (settings) {
            xInput.value = settings.x;
            yInput.value = settings.y;
            zInput.value = settings.z;
            if (settings.profile) {
                profileSelect.value = settings.profile;
            }
        }
    }

    async function loadSavedPoints() {
        try {
            const response = await fetch('/focus/points');
            const points = await response.json();
            
            pointsList.innerHTML = points.map((point, index) => `
                <div class="point-card" onclick="loadPoint(${JSON.stringify(point).replace(/"/g, '&quot;')})">
                    <h3>Point ${index + 1}</h3>
                    <div class="coordinates">X: ${point.x}mm</div>
                    <div class="coordinates">Y: ${point.y}mm</div>
                    <div class="coordinates">Z: ${point.z}mm</div>
                    <button class="delete-btn" onclick="event.stopPropagation(); deletePoint(${index})">Ã—</button>
                </div>
            `).join('');

            document.querySelectorAll('.point-card').forEach(card => {
                card.style.cursor = 'pointer';
            });
        } catch (error) {
            console.error('Error loading focus points:', error);
        }
    }

    window.loadPoint = function(point) {
        xInput.value = point.x;
        yInput.value = point.y;
        zInput.value = point.z;
        saveToLocalStorage();
    };

    window.deletePoint = async function(index) {
        try {
            const response = await fetch(`/focus/point/${index}`, {
                method: 'DELETE'
            });
            if (response.ok) {
                loadSavedPoints();
            }
        } catch (error) {
            console.error('Error deleting point:', error);
        }
    };

    loadProfileButton.addEventListener('click', async () => {
        const profileName = profileSelect.value;
        if (!profileName) {
            alert('Please select a profile');
            return;
        }

        try {
            const response = await fetch(`/profile/${profileName}`);
            if (!response.ok) throw new Error('Failed to load profile');
            
            const profileData = await response.json();
            if (profileData.points && profileData.points.length > 0) {
                // Use the first point's positions for focus settings
                const firstPoint = profileData.points[0];
                xInput.value = firstPoint.x || 400;
                yInput.value = firstPoint.y || 600;
                zInput.value = firstPoint.z || -300;
                saveToLocalStorage();
            }
        } catch (error) {
            console.error('Error loading profile:', error);
            alert('Failed to load profile settings');
        }
    });

    startButton.addEventListener('click', async () => {
        try {
            let point;
            try {
                point = getFocusPoint();
            } catch (e) {
                alert('Please enter valid coordinate values');
                return;
            }

            console.log('Starting tracking with point:', point);
            const response = await fetch('/focus/start_tracking', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(point)
            });

            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || 'Failed to start tracking');
            }

            updateButtonStates(true);
        } catch (error) {
            console.error('Error starting tracking:', error);
            alert('Failed to start tracking');
        }
    });

    stopButton.addEventListener('click', async () => {
        try {
            console.log('Stopping tracking');
            const response = await fetch('/focus/stop_tracking', {
                method: 'POST'
            });

            if (!response.ok) {
                throw new Error('Failed to stop tracking');
            }

            updateButtonStates(false);
        } catch (error) {
            console.error('Error stopping tracking:', error);
            alert('Failed to stop tracking');
        }
    });

    saveButton.addEventListener('click', async () => {
        try {
            const point = getFocusPoint();
            console.log('Saving focus point:', point);
            const response = await fetch('/focus/save_point', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(point)
            });

            if (!response.ok) {
                throw new Error('Failed to save point');
            }

            loadSavedPoints();
        } catch (error) {
            console.error('Error saving focus point:', error);
            alert('Failed to save focus point');
        }
    });

    // Save settings when inputs change
    [xInput, yInput, zInput, profileSelect].forEach(input => {
        input.addEventListener('change', saveToLocalStorage);
    });

    // Load initial data
    loadProfiles();
    loadSavedPoints();
    loadFromLocalStorage();
});
</script>
{% endblock %}
