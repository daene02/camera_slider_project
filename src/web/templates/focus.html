{% extends "base.html" %}

{% block styles %}
<style>
body {
    background-color: #1a1a2e;
    color: white;
}

.container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.focus-controls {
    display: grid;
    gap: 20px;
}

.form-control {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
}

.btn {
    background-color: #4a4e69;
    color: white;
    border: none;
}

.btn-primary {
    background-color: #22577a;
}

.btn-danger {
    background-color: #8b0000;
}

.points-list {
    max-height: 300px;
    overflow-y: auto;
}

.point-card {
    background: rgba(255, 255, 255, 0.1);
    margin-bottom: 10px;
    padding: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h2>Focus Point Control</h2>
    
    <div class="focus-controls">
        <div class="row">
            <div class="col-md-6">
                <input type="text" id="point-name" class="form-control mb-2" placeholder="Point Name">
                <div class="input-group mb-2">
                    <input type="number" id="x-pos" class="form-control" placeholder="X">
                    <input type="number" id="y-pos" class="form-control" placeholder="Y">
                    <input type="number" id="z-pos" class="form-control" placeholder="Z">
                </div>
                <div class="d-flex mb-2">
                    <input type="color" id="point-color" class="form-control" value="#4a9eff">
                    <button id="savePoint" class="btn btn-primary ml-2">Save</button>
                </div>
                <div class="btn-group w-100">
                    <button id="startTracking" class="btn btn-success">Start</button>
                    <button id="stopTracking" class="btn btn-danger" disabled>Stop</button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="points-list" id="pointsList"></div>
            </div>
        </div>
    </div>
    
    <div class="text-right mt-3">
        <a href="/focus/visualization" target="_blank" class="btn btn-secondary">
            3D Visualization
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const saveButton = document.getElementById('savePoint');
    const startButton = document.getElementById('startTracking');
    const stopButton = document.getElementById('stopTracking');
    const pointNameInput = document.getElementById('point-name');
    const pointColorInput = document.getElementById('point-color');
    const xInput = document.getElementById('x-pos');
    const yInput = document.getElementById('y-pos');
    const zInput = document.getElementById('z-pos');
    const pointsList = document.getElementById('pointsList');

    let currentPointId = null;
    let savedPoints = [];

    async function loadFocusPoints() {
        try {
            const response = await fetch('/focus/points');
            savedPoints = await response.json();
            renderPointsList();
        } catch (error) {
            console.error('Error loading points:', error);
        }
    }

    function renderPointsList() {
        pointsList.innerHTML = savedPoints.map(point => `
            <div class="point-card">
                <div>
                    <strong>${point.name}</strong>
                    <div>X: ${point.x}, Y: ${point.y}, Z: ${point.z}</div>
                </div>
                <div>
                    <input type="color" value="${point.color}" disabled>
                    <button onclick="usePoint(${point.id})" class="btn btn-sm btn-primary">Use</button>
                    <button onclick="deletePoint(${point.id})" class="btn btn-sm btn-danger">Ã—</button>
                </div>
            </div>
        `).join('');
    }

    window.usePoint = async function(pointId) {
        try {
            const response = await fetch(`/focus/point/${pointId}`);
            const point = await response.json();
            pointNameInput.value = point.name;
            xInput.value = point.x;
            yInput.value = point.y;
            zInput.value = point.z;
            pointColorInput.value = point.color;
        } catch (error) {
            console.error('Error:', error);
        }
    };

    window.deletePoint = async function(pointId) {
        if (pointId === undefined || pointId === null) {
            console.error('Invalid point ID');
            return;
        }

        try {
            const response = await fetch(`/focus/point/${pointId}`, { 
                method: 'DELETE'
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to delete point');
            }

            await loadFocusPoints();
        } catch (error) {
            console.error('Error:', error);
            alert(error.message || 'Failed to delete point');
        }
    };

    saveButton.addEventListener('click', async () => {
        const pointData = {
            name: pointNameInput.value || `Point ${Date.now()}`,
            color: pointColorInput.value,
            x: parseFloat(xInput.value),
            y: parseFloat(yInput.value),
            z: parseFloat(zInput.value)
        };

        try {
            await fetch('/focus/save_point', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pointData)
            });
            
            await loadFocusPoints();
            pointNameInput.value = '';
            xInput.value = '';
            yInput.value = '';
            zInput.value = '';
        } catch (error) {
            console.error('Error:', error);
        }
    });

    startButton.addEventListener('click', async () => {
        const point = {
            x: parseFloat(xInput.value),
            y: parseFloat(yInput.value),
            z: parseFloat(zInput.value)
        };

        try {
            await fetch('/focus/start_tracking', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(point)
            });

            startButton.disabled = true;
            stopButton.disabled = false;
        } catch (error) {
            console.error('Error:', error);
        }
    });

    stopButton.addEventListener('click', async () => {
        try {
            await fetch('/focus/stop_tracking', { method: 'POST' });
            startButton.disabled = false;
            stopButton.disabled = true;
        } catch (error) {
            console.error('Error:', error);
        }
    });

    loadFocusPoints();
});
</script>
{% endblock %}
