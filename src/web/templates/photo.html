{% extends "base.html" %}

{% block title %}Photo Mode{% endblock %}

{% block content %}
<div class="control-section">
    <h1 class="text-xlarge">Photo Mode</h1>

    <!-- Camera Connection Status -->
    <div class="camera-status">
        <h2>Camera Status</h2>
        <div class="control-panel">
            <div class="status-row">
                <label>Connection:</label>
                <span id="camera-connection">Not Connected</span>
                <button id="connect-camera" class="btn">Connect Camera</button>
            </div>
            <div class="status-row">
                <label>Storage:</label>
                <span id="storage-info">N/A</span>
            </div>
            <div class="status-row">
                <label>Battery:</label>
                <span id="battery-info">N/A</span>
            </div>
        </div>
    </div>

    <!-- Live View -->
    <div class="live-view-panel">
        <div class="live-view-controls">
            <button id="toggle-live-view" class="btn" disabled>Enable Live View</button>
        </div>
        <div id="live-view-container" style="display: none;">
            <img id="live-view" src="" alt="Camera Live View">
        </div>
    </div>
    
    <div class="photo-controls">
        <h2>Camera Settings</h2>
        <div class="control-panel">
            <div class="setting-row">
                <label>Photo Resolution:</label>
                <select id="resolution" class="form-control">
                    <option value="raw">RAW</option>
                    <option value="jpeg-high">JPEG High (20MP)</option>
                    <option value="jpeg-med">JPEG Medium (12MP)</option>
                </select>
            </div>
            <div class="setting-row">
                <label>Interval (seconds):</label>
                <input type="number" id="interval" value="2" min="1" max="3600" class="form-control">
            </div>
            <div class="setting-row">
                <label>Number of Photos:</label>
                <input type="number" id="photo-count" value="10" min="1" max="1000" class="form-control">
            </div>
            <div class="setting-row">
                <label>Delay Before Start:</label>
                <input type="number" id="start-delay" value="3" min="0" max="60" class="form-control">
            </div>
        </div>
    </div>

    <div class="motion-controls">
        <h2>Motion Settings</h2>
        <div class="control-panel">
            <div class="setting-row">
                <label>Movement Profile:</label>
                <select id="profile" class="form-control">
                    <option value="">Select a profile...</option>
                </select>
            </div>
            <div class="setting-row">
                <label>Focus Mode:</label>
                <select id="focus-mode" class="form-control">
                    <option value="track">Track Focus Point</option>
                    <option value="fixed">Fixed Focus</option>
                    <option value="manual">Manual Focus</option>
                </select>
            </div>
            <div class="setting-row">
                <label>Movement Type:</label>
                <select id="movement-type" class="form-control">
                    <option value="continuous">Continuous</option>
                    <option value="step">Step-by-Step</option>
                </select>
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <button id="start-sequence" class="btn btn-success">Start Photo Sequence</button>
        <button id="stop-sequence" class="btn btn-danger" disabled>Stop Sequence</button>
        <button id="preview" class="btn btn-primary">Preview Movement</button>
    </div>

    <div class="status-panel" style="display: none;">
        <h2>Sequence Status</h2>
        <div class="status-info">
            <div class="info-row">
                <label>Photos:</label>
                <span id="photos-taken">0</span> / <span id="total-photos">0</span>
            </div>
            <div class="info-row">
                <label>Next Photo:</label>
                <span id="next-photo-time">--:--</span>
            </div>
            <div class="info-row">
                <label>Status:</label>
                <span id="sequence-status">Ready</span>
            </div>
            <div class="progress-bar">
                <div class="progress"></div>
            </div>
            <div class="photo-grid" id="photo-thumbnails">
                <!-- Thumbnails will be added here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Camera control elements
    const connectBtn = document.getElementById('connect-camera');
    const cameraStatus = document.getElementById('camera-connection');
    const storageInfo = document.getElementById('storage-info');
    const batteryInfo = document.getElementById('battery-info');
    const liveViewBtn = document.getElementById('toggle-live-view');
    const liveViewContainer = document.getElementById('live-view-container');
    const liveView = document.getElementById('live-view');

    // Camera connection
    async function connectCamera() {
        try {
            const response = await fetch('/camera/connect', {
                method: 'POST'
            });
            
            if (response.ok) {
                await updateCameraStatus();
                connectBtn.style.display = 'none';
                liveViewBtn.disabled = false;
                startButton.disabled = false;
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Failed to connect camera');
            }
        } catch (error) {
            console.error('Camera connection error:', error);
            alert('Failed to connect camera: ' + error.message);
        }
    }

    // Update camera status
    async function updateCameraStatus() {
        try {
            const response = await fetch('/camera/status');
            const status = await response.json();
            
            if (status.connected) {
                cameraStatus.textContent = 'Connected';
                cameraStatus.className = 'connected';
                
                if (status.storage) {
                    storageInfo.textContent = `${status.storage.available_shots} shots remaining`;
                }
                
                if (status.storage && status.storage.battery_level !== undefined) {
                    batteryInfo.textContent = `${status.storage.battery_level}%`;
                }
                
                // Update live view status
                liveViewBtn.textContent = status.live_view ? 'Disable Live View' : 'Enable Live View';
                liveViewContainer.style.display = status.live_view ? 'block' : 'none';
            } else {
                cameraStatus.textContent = 'Not Connected';
                cameraStatus.className = '';
                storageInfo.textContent = 'N/A';
                batteryInfo.textContent = 'N/A';
            }
        } catch (error) {
            console.error('Error updating camera status:', error);
        }
    }

    // Live view toggle
    async function toggleLiveView() {
        try {
            const response = await fetch('/camera/live_view/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    enable: liveViewContainer.style.display === 'none'
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                liveViewContainer.style.display = result.enabled ? 'block' : 'none';
                liveViewBtn.textContent = result.enabled ? 'Disable Live View' : 'Enable Live View';
                
                if (result.enabled) {
                    // Start live view update loop
                    updateLiveView();
                }
            }
        } catch (error) {
            console.error('Error toggling live view:', error);
            alert('Failed to toggle live view');
        }
    }

    // Update live view image
    function updateLiveView() {
        if (liveViewContainer.style.display === 'block') {
            liveView.src = `/camera/live_view?t=${Date.now()}`;
            setTimeout(updateLiveView, 100);  // Update every 100ms
        }
    }

    // Connect event listeners
    connectBtn.addEventListener('click', connectCamera);
    liveViewBtn.addEventListener('click', toggleLiveView);

    // Load profiles
    fetch('/profile/list')
        .then(response => response.json())
        .then(profiles => {
            const select = document.getElementById('profile');
            profiles.forEach(profile => {
                const option = document.createElement('option');
                option.value = profile;
                option.textContent = profile;
                select.appendChild(option);
            });
        });

    let sequenceInterval;
    let photoCount = 0;
    let nextPhotoTime;
    const statusPanel = document.querySelector('.status-panel');
    const startButton = document.getElementById('start-sequence');
    const stopButton = document.getElementById('stop-sequence');
    const previewButton = document.getElementById('preview');
    const photosTaken = document.getElementById('photos-taken');
    const totalPhotos = document.getElementById('total-photos');
    const nextPhotoTimer = document.getElementById('next-photo-time');
    const progress = document.querySelector('.progress');
    const sequenceStatus = document.getElementById('sequence-status');
    const thumbnailsGrid = document.getElementById('photo-thumbnails');

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function updateNextPhotoTime() {
        const now = Date.now();
        const remainingSeconds = Math.max(0, (nextPhotoTime - now) / 1000);
        nextPhotoTimer.textContent = formatTime(remainingSeconds);
    }

    function addThumbnail(number) {
        const thumbnail = document.createElement('div');
        thumbnail.className = 'photo-thumbnail';
        thumbnail.innerHTML = `
            <div class="number">#${number}</div>
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=" alt="Photo ${number}">
        `;
        thumbnailsGrid.appendChild(thumbnail);
    }

    async function startSequence() {
        if (!cameraStatus.className.includes('connected')) {
            alert('Please connect the camera first');
            return;
        }

        const totalCount = parseInt(document.getElementById('photo-count').value);
        const interval = parseInt(document.getElementById('interval').value) * 1000;
        const startDelay = parseInt(document.getElementById('start-delay').value) * 1000;

        photoCount = 0;
        totalPhotos.textContent = totalCount;
        statusPanel.style.display = 'block';
        startButton.disabled = true;
        stopButton.disabled = false;
        previewButton.disabled = true;
        sequenceStatus.textContent = 'Starting...';
        thumbnailsGrid.innerHTML = '';
        
        setTimeout(() => {
            sequenceStatus.textContent = 'Running';
            nextPhotoTime = Date.now() + interval;
            
            sequenceInterval = setInterval(async () => {
                if (photoCount >= totalCount) {
                    stopSequence();
                    return;
                }

                try {
                    // Take photo
                    const response = await fetch('/camera/capture', { method: 'POST' });
                    if (response.ok) {
                        photoCount++;
                        photosTaken.textContent = photoCount;
                        const percent = (photoCount / totalCount) * 100;
                        progress.style.width = `${percent}%`;
                        addThumbnail(photoCount);
                        nextPhotoTime = Date.now() + interval;
                        await updateCameraStatus(); // Update storage info
                    } else {
                        console.error('Failed to capture photo');
                    }
                } catch (error) {
                    console.error('Error during photo capture:', error);
                    stopSequence();
                }
            }, interval);

            // Update countdown timer
            setInterval(updateNextPhotoTime, 100);
        }, startDelay);
    }

    function stopSequence() {
        clearInterval(sequenceInterval);
        startButton.disabled = false;
        stopButton.disabled = true;
        previewButton.disabled = false;
        sequenceStatus.textContent = 'Completed';
        nextPhotoTimer.textContent = '--:--';
        
        fetch('/profile/stop', { method: 'POST' });
    }

    function previewMovement() {
        const profile = document.getElementById('profile').value;
        if (profile) {
            fetch(`/profile/${profile}`)
                .then(response => response.json())
                .then(profileData => {
                    const settings = {
                        ...profileData.settings,
                        movement_type: document.getElementById('movement-type').value,
                        focus_mode: document.getElementById('focus-mode').value
                    };
                    return fetch('/profile/play', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            profile: profileData,
                            settings: settings
                        })
                    });
                });
        }
    }

    startButton.addEventListener('click', startSequence);
    stopButton.addEventListener('click', stopSequence);
    previewButton.addEventListener('click', previewMovement);

    // Update movement type UI
    document.getElementById('movement-type').addEventListener('change', (e) => {
        const interval = document.getElementById('interval');
        if (e.target.value === 'step') {
            interval.min = '0';
            interval.value = '0';
            interval.disabled = true;
        } else {
            interval.min = '1';
            interval.value = '2';
            interval.disabled = false;
        }
    });
});
</script>
{% endblock %}
