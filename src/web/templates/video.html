{% extends "base.html" %}

{% block title %}Video Mode{% endblock %}

{% block content %}
<div class="control-section">
    <h1 class="text-xlarge">Video Mode</h1>
    
    <!-- Camera Connection Status -->
    <div class="camera-status">
        <h2>Camera Status</h2>
        <div class="control-panel">
            <div class="status-row">
                <label>Connection:</label>
                <span id="camera-connection">Not Connected</span>
                <button id="connect-camera" class="btn">Connect Camera</button>
            </div>
            <div class="status-row">
                <label>Storage:</label>
                <span id="storage-info">N/A</span>
            </div>
            <div class="status-row">
                <label>Battery:</label>
                <span id="battery-info">N/A</span>
            </div>
        </div>
    </div>

    <!-- Live View -->
    <div class="live-view-panel">
        <div class="live-view-controls">
            <button id="toggle-live-view" class="btn" disabled>Enable Live View</button>
        </div>
        <div id="live-view-container" style="display: none;">
            <img id="live-view" src="" alt="Camera Live View">
        </div>
    </div>
    <div class="video-controls">
        <h2>Camera Settings</h2>
        <div class="control-panel">
            <div class="setting-row">
                <label>Recording Resolution:</label>
                <select id="resolution" class="form-control">
                    <option value="4k">4K (3840x2160)</option>
                    <option value="1080p">1080p (1920x1080)</option>
                    <option value="720p">720p (1280x720)</option>
                </select>
            </div>
            <div class="setting-row">
                <label>Frame Rate:</label>
                <select id="framerate" class="form-control">
                    <option value="60">60 fps</option>
                    <option value="30">30 fps</option>
                    <option value="24">24 fps</option>
                </select>
            </div>
        </div>
    </div>

    <div class="motion-controls">
        <h2>Motion Settings</h2>
        <div class="control-panel">
            <div class="setting-row">
                <label>Velocity (from Duration):</label>
                <input type="number" id="duration" value="10" min="1" max="3600" class="form-control">
                <span class="hint">seconds (lower = faster)</span>
            </div>
            <div class="setting-row">
                <label>Movement Profile:</label>
                <select id="profile" class="form-control">
                    <option value="">Select a profile...</option>
                </select>
            </div>
            <div class="focus-control-panel">
                <h3>Focus Control</h3>
                <div class="setting-row">
                    <button id="focus-tracking" class="btn">Start Focus Tracking</button>
                </div>
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <button id="start-record" class="btn btn-success">Start Recording</button>
        <button id="stop-record" class="btn btn-danger" disabled>Stop Recording</button>
        <button id="preview" class="btn btn-primary">Preview Movement</button>
    </div>

    <div class="status-panel" style="display: none;">
        <h2>Recording Status</h2>
        <div class="status-info">
            <div class="info-row">
                <label>Duration:</label>
                <span id="time-elapsed">00:00</span> / <span id="time-total">00:00</span>
            </div>
            <div class="info-row">
                <label>Status:</label>
                <span id="recording-status">Ready</span>
            </div>
            <div class="progress-bar">
                <div class="progress" style="width: 0%"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Camera control elements
    const connectBtn = document.getElementById('connect-camera');
    const cameraStatus = document.getElementById('camera-connection');
    const storageInfo = document.getElementById('storage-info');
    const batteryInfo = document.getElementById('battery-info');
    const liveViewBtn = document.getElementById('toggle-live-view');
    const liveViewContainer = document.getElementById('live-view-container');
    const liveView = document.getElementById('live-view');

    // Camera connection
    async function connectCamera() {
        try {
            const response = await fetch('/camera/connect', {
                method: 'POST'
            });
            
            if (response.ok) {
                await updateCameraStatus();
                connectBtn.style.display = 'none';
                liveViewBtn.disabled = false;
            } else {
                const error = await response.json();
                throw new Error(error.error || 'Failed to connect camera');
            }
        } catch (error) {
            console.error('Camera connection error:', error);
            alert('Failed to connect camera: ' + error.message);
        }
    }

    // Update camera status
    async function updateCameraStatus() {
        try {
            const response = await fetch('/camera/status');
            const status = await response.json();
            
            if (status.connected) {
                cameraStatus.textContent = 'Connected';
                cameraStatus.className = 'connected';
                
                if (status.storage) {
                    storageInfo.textContent = `${status.storage.available_shots} shots remaining`;
                }
                
                if (status.storage && status.storage.battery_level !== undefined) {
                    batteryInfo.textContent = `${status.storage.battery_level}%`;
                }
                
                // Update live view status
                liveViewBtn.textContent = status.live_view ? 'Disable Live View' : 'Enable Live View';
                liveViewContainer.style.display = status.live_view ? 'block' : 'none';
            } else {
                cameraStatus.textContent = 'Not Connected';
                cameraStatus.className = '';
                storageInfo.textContent = 'N/A';
                batteryInfo.textContent = 'N/A';
            }
        } catch (error) {
            console.error('Error updating camera status:', error);
        }
    }

    // Live view toggle
    async function toggleLiveView() {
        try {
            const response = await fetch('/camera/live_view/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    enable: liveViewContainer.style.display === 'none'
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                liveViewContainer.style.display = result.enabled ? 'block' : 'none';
                liveViewBtn.textContent = result.enabled ? 'Disable Live View' : 'Enable Live View';
                
                if (result.enabled) {
                    // Start live view update loop
                    updateLiveView();
                }
            }
        } catch (error) {
            console.error('Error toggling live view:', error);
            alert('Failed to toggle live view');
        }
    }

    // Update live view image
    function updateLiveView() {
        if (liveViewContainer.style.display === 'block') {
            liveView.src = `/camera/live_view?t=${Date.now()}`;
            setTimeout(updateLiveView, 100);  // Update every 100ms
        }
    }

    // Connect event listeners
    connectBtn.addEventListener('click', connectCamera);
    liveViewBtn.addEventListener('click', toggleLiveView);

    // Load profiles
    function loadProfiles() {
        fetch('/profile/list')
            .then(response => response.json())
            .then(profiles => {
                const select = document.getElementById('profile');
                select.innerHTML = '<option value="">Select a profile...</option>';
                
                profiles.forEach(profile => {
                    const option = document.createElement('option');
                    option.value = profile;
                    option.textContent = profile;
                    select.appendChild(option);
                });
                console.log('Loaded profiles:', profiles);
            })
            .catch(error => {
                console.error('Error loading profiles:', error);
                alert('Failed to load movement profiles');
            });
    }
    
    // Duration to velocity conversion
    function durationToVelocity(duration) {
        const minDuration = 1;  // 1 second
        const maxDuration = 3600;  // 1 hour
        const minVelocity = 50;  // minimum safe velocity
        const maxVelocity = 1023;  // maximum velocity
        
        // Invert and scale
        const velocity = Math.round(
            maxVelocity - ((duration - minDuration) / (maxDuration - minDuration)) * (maxVelocity - minVelocity)
        );
        
        return Math.min(Math.max(velocity, minVelocity), maxVelocity);
    }
    
    // Load profiles when page loads
    loadProfiles();

    let recordingInterval;
    let startTime;
    const statusPanel = document.querySelector('.status-panel');
    const startButton = document.getElementById('start-record');
    const stopButton = document.getElementById('stop-record');
    const previewButton = document.getElementById('preview');
    const timeElapsed = document.getElementById('time-elapsed');
    const timeTotal = document.getElementById('time-total');
    const progress = document.querySelector('.progress');
    const recordingStatus = document.getElementById('recording-status');

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function updateProgress() {
        const now = Date.now();
        const elapsed = (now - startTime) / 1000;
        const duration = parseInt(document.getElementById('duration').value);
        const percent = Math.min((elapsed / duration) * 100, 100);
        
        timeElapsed.textContent = formatTime(elapsed);
        progress.style.width = `${percent}%`;

        if (elapsed >= duration) {
            stopRecording();
        }
    }

    // Focus tracking toggle
    let isTracking = false;
    const focusTrackingBtn = document.getElementById('focus-tracking');

    async function toggleFocusTracking() {
        if (!isTracking) {
            try {
                // Get saved focus settings
                const settings = JSON.parse(localStorage.getItem('focusSettings'));
                if (!settings || !settings.x || !settings.y || !settings.z) {
                    alert('Please set focus point in Focus Control page first');
                    return;
                }

                const point = {
                    x: parseFloat(settings.x),
                    y: parseFloat(settings.y),
                    z: parseFloat(settings.z)
                };

                const response = await fetch('/focus/start_tracking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(point)
                });

                const data = await response.json();
                if (response.ok) {
                    isTracking = true;
                    focusTrackingBtn.textContent = 'Stop Focus Tracking';
                    focusTrackingBtn.classList.add('active');
                    window.activePoint = point;
                } else {
                    throw new Error(data.error || 'Failed to start focus tracking');
                }
            } catch (error) {
                console.error('Error starting focus tracking:', error);
                alert('Failed to start focus tracking');
            }
        } else {
            try {
                const response = await fetch('/focus/stop_tracking', {
                    method: 'POST'
                });

                if (response.ok) {
                    isTracking = false;
                    focusTrackingBtn.textContent = 'Start Focus Tracking';
                    focusTrackingBtn.classList.remove('active');
                }
            } catch (error) {
                console.error('Error stopping focus tracking:', error);
                alert('Failed to stop focus tracking');
            }
        }
    }

    focusTrackingBtn.addEventListener('click', toggleFocusTracking);

    // Modified startRecording function
    async function startRecording() {
        const profileName = document.getElementById('profile').value;
        if (!profileName) {
            alert('Please select a movement profile');
            return;
        }

        try {
            // Start video recording
            const recordResponse = await fetch('/camera/video/start', {
                method: 'POST'
            });
            
            if (!recordResponse.ok) {
                const error = await recordResponse.json();
                throw new Error(error.error || 'Failed to start recording');
            }

            // Get profile data
            const profileResponse = await fetch(`/profile/${profileName}`);
            if (!profileResponse.ok) throw new Error('Failed to load profile');
            const profileData = await profileResponse.json();

            // Start recording sequence
            const duration = parseInt(document.getElementById('duration').value);
            timeTotal.textContent = formatTime(duration);
            startTime = Date.now();
            statusPanel.style.display = 'block';
            recordingStatus.textContent = 'Recording';

            // Setup playback settings
            const settings = {
                velocity: durationToVelocity(duration),
                acceleration: 50,
                focus: isTracking && window.activePoint ? {
                    point: window.activePoint,
                    offset: 0
                } : null,
                duration: duration
            };

            // Start profile playback
            const playResponse = await fetch('/profile/play', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    profile: profileData,
                    settings: settings
                })
            });

            if (!playResponse.ok) throw new Error('Failed to start profile playback');

            // Update UI
            startButton.disabled = true;
            stopButton.disabled = false;
            previewButton.disabled = true;
            recordingInterval = setInterval(updateProgress, 100);

            console.log('Recording started with profile:', profileName);
        } catch (error) {
            console.error('Error starting recording:', error);
            alert('Failed to start recording: ' + error.message);
            stopRecording();
        }
    }

    // Modified stopRecording function
    async function stopRecording() {
        try {
            // Stop video recording
            await fetch('/camera/video/stop', { method: 'POST' });
            
            // Stop profile playback
            await fetch('/profile/stop', { method: 'POST' });
            
            clearInterval(recordingInterval);
            startButton.disabled = false;
            stopButton.disabled = true;
            previewButton.disabled = false;
            recordingStatus.textContent = 'Completed';
        } catch (error) {
            console.error('Error stopping recording:', error);
            alert('Error stopping recording');
        }
    }

    async function previewMovement() {
        const profileName = document.getElementById('profile').value;
        if (!profileName) {
            alert('Please select a movement profile');
            return;
        }

        try {
            // Get profile data
            const profileResponse = await fetch(`/profile/${profileName}`);
            if (!profileResponse.ok) throw new Error('Failed to load profile');
            const profileData = await profileResponse.json();

            // Setup playback settings
            const duration = parseInt(document.getElementById('duration').value);
            const settings = {
                velocity: durationToVelocity(duration),
                acceleration: 50,
                focus: isTracking && window.activePoint ? {
                    point: window.activePoint,
                    offset: 0
                } : null,
                duration: duration
            };

            // Start profile playback
            const playResponse = await fetch('/profile/play', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    profile: profileData,
                    settings: settings
                })
            });

            if (!playResponse.ok) {
                throw new Error('Failed to start preview');
            }

            console.log('Preview started successfully');
        } catch (error) {
            console.error('Error during preview:', error);
            alert('Failed to start preview: ' + error.message);
        }
    }

    startButton.addEventListener('click', startRecording);
    stopButton.addEventListener('click', stopRecording);
    previewButton.addEventListener('click', previewMovement);
});
</script>
{% endblock %}
