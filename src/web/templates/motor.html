{% extends "base.html" %}

{% block title %}Motor Settings{% endblock %}

{% block content %}
<h1 class="text-xlarge">Motor Settings</h1>
<div class="torque-controls">
    <button onclick="toggleAllTorque(true)" class="btn btn-enable">
        Enable All Torque
    </button>
    <button onclick="toggleAllTorque(false)" class="btn btn-disable">
        Disable All Torque
    </button>
</div>

<div class="motor-grid">
    {% for motor in motors %}
    <div class="motor-box {{ 'enabled' if motor.torque_enabled else 'disabled' }}" data-motor-id="{{ motor.id }}">
        <div class="motor-header">
            <h2 class="motor-name {{ 'enabled' if motor.torque_enabled else 'disabled' }}">
                {{ motor.name }}
            </h2>
            <div class="btn-group">
                <button onclick="toggleTorque({{ motor.id }}, true)" class="btn btn-enable">Enable</button>
                <button onclick="toggleTorque({{ motor.id }}, false)" class="btn btn-disable">Disable</button>
            </div>
        </div>
        <div class="motor-stats">
            <div class="motor-value position">
                <label>Position:</label>
                <div class="value-container">
                    <span class="raw-value">{{ motor.position }}</span>
                    <span class="position-value" data-motor-id="{{ motor.id }}">{{ motor.position }}</span>
                    <span class="unit">{% if motor.id == 2 %}mm{% else %}°{% endif %}</span>
                </div>
            </div>
            <div class="motor-value">
                <label>Temperature{% if motor.temperature > 60 %}⚠️{% endif %}:</label>
                <div class="value-container">
                    <span class="temperature-value {{ 'warning' if motor.temperature > 55 else 'error' if motor.temperature > 65 }}">
                        {{ motor.temperature }}
                    </span>
                    <span class="unit">°C</span>
                </div>
            </div>
            <div class="motor-value">
                <label>Velocity:</label>
                <div class="value-container">
                    <span class="speed-value">{{ motor.speed }}</span>
                    <span class="unit">steps/s</span>
                </div>
            </div>
            <div class="motor-value">
                <label>Acceleration:</label>
                <div class="value-container">
                    <span class="load-value">{{ motor.load }}</span>
                    <span class="unit">steps/s²</span>
                </div>
            </div>
            <div class="motor-value">
                <label>Current:</label>
                <div class="value-container">
                    <span class="current-value">{{ motor.current }}</span>
                    <span class="unit">mA</span>
                </div>
            </div>
            <div class="motor-value">
                <label>Voltage{% if motor.voltage < 11 %}⚠️{% endif %}:</label>
                <div class="value-container">
                    <span class="voltage-value {{ 'low' if motor.voltage < 11.5 }}">
                        {{ motor.voltage }}
                    </span>
                    <span class="unit">V</span>
                </div>
            </div>
            <div class="pid-info">
                <div class="position-pid" data-motor-id="{{ motor.id }}">
                    <span>Position PID:</span>
                    <span>P: {{ motor.position_pid.p }}, I: {{ motor.position_pid.i }}, D: {{ motor.position_pid.d }}</span>
                </div>
                <div class="velocity-pid" data-motor-id="{{ motor.id }}">
                    <span>Velocity PID:</span>
                    <span>P: {{ motor.velocity_pid.p }}, I: {{ motor.velocity_pid.i }}</span>
                </div>
            </div>
        </div>
        
        {% if motor.id in [2, 3, 4] %}
        <div class="filter-status">
            <h3>Kalman Filter Status</h3>
            <div class="filter-stats">
                <div class="status-chart">
                    <canvas id="motor{{ motor.id }}_chart"></canvas>
                </div>
                <div class="chart-metrics">
                    <div class="metric prediction-time">
                        <span class="label">Prediction Time:</span>
                        <span class="prediction-time-value" data-motor-id="{{ motor.id }}">{{ motor.prediction_time|default(0.0, true)|round(3) }}</span>
                        <span class="unit">ms</span>
                    </div>
                    <div class="metric position">
                        <span class="label">Est. Position:</span>
                        <span class="estimated-position" data-motor-id="{{ motor.id }}">{{ motor.estimated_position|default(0.0, true)|round(2) }}</span>
                        <span class="unit">{% if motor.id == 2 %}mm{% else %}°{% endif %}</span>
                    </div>
                    <div class="metric velocity">
                        <span class="label">Est. Velocity:</span>
                        <span class="estimated-velocity" data-motor-id="{{ motor.id }}">{{ motor.estimated_velocity|default(0.0, true)|round(2) }}</span>
                        <span class="unit">{% if motor.id == 2 %}mm/s{% else %}°/s{% endif %}</span>
                    </div>
                    <div class="metric prediction-error">
                        <span class="label">Pred. Error:</span>
                        <span class="prediction-error" data-motor-id="{{ motor.id }}">{{ motor.prediction_error|default(0.0, true)|round(2) }}</span>
                    </div>
                    <div class="metric uncertainty">
                        <span class="label">Uncertainty:</span>
                        <span class="filter-uncertainty" data-motor-id="{{ motor.id }}">{{ motor.filter_uncertainty|default(0.0, true)|round(2) }}</span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="motor-controls">
            <div class="control-group">
                <label for="position_{{ motor.id }}">Position ({% if motor.id == 2 %}mm{% else %}°{% endif %}):</label>
                <input type="number"
                       class="form-control"
                       id="position_{{ motor.id }}"
                       value="{{ motor.position }}"
                       min="{% if motor.id in [3, 4] %}-180{% elif motor.id == 2 %}0{% else %}0{% endif %}"
                       max="{% if motor.id in [3, 4] %}180{% elif motor.id == 2 %}800{% else %}360{% endif %}"
                       step="0.1">
                <button onclick="updateMotorPosition({{ motor.id }})" class="btn">Set</button>
            </div>

            <div class="control-group">
                <label for="velocity_{{ motor.id }}">Velocity (ms):</label>
                <input type="number"
                       class="form-control" 
                       id="velocity_{{ motor.id }}"
                       value="100"
                       min="0"
                       max="32000">
                <button onclick="updateMotorVelocity({{ motor.id }})" class="btn">Set</button>
            </div>

            <div class="control-group">
                <label for="acceleration_{{ motor.id }}">Acceleration (ms):</label>
                <input type="number"
                       class="form-control"
                       id="acceleration_{{ motor.id }}"
                       value="50"
                       min="0"
                       max="32000">
                <button onclick="updateMotorAcceleration({{ motor.id }})" class="btn">Set</button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- JavaScript Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<!-- Application Scripts -->
<script src="/static/main.js"></script>
<script src="/static/notifications.js"></script>
<script src="/static/motor_init.js"></script>
<script src="/static/motor_monitor.js"></script>
<script src="/static/motor_charts.js"></script>
<script src="/static/motor_status.js"></script>

<!-- Load styles -->
<link rel="stylesheet" href="/static/styles.css">

<!-- Initialize motor monitoring -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const motorData = {{ motors|tojson|safe }};
    motorMonitor.initialize(motorData);
});
</script>
{% endblock %}
