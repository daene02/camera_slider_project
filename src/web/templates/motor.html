{% extends "base.html" %}

{% block title %}Motor Settings{% endblock %}

{% block content %}
<h1 class="text-xlarge">Motor Settings</h1>
<div class="torque-controls">
    <button onclick="toggleAllTorque(true)" class="btn btn-enable">
        Enable All Torque
    </button>
    <button onclick="toggleAllTorque(false)" class="btn btn-disable">
        Disable All Torque
    </button>
</div>

<div class="motor-grid">
    {% for motor in motors %}
    {# Disable JavaScript validation for Jinja2 template expressions #}
{# prettier-ignore-start #}
<div class="motor-box {{ 'enabled' if motor.torque_enabled else 'disabled' }}" 
     data-motor-id="{{ motor.id }}"
     data-update-enabled="true">
{# prettier-ignore-end #}
        <div class="motor-header">
            <h2 class="motor-name {{ 'enabled' if motor.torque_enabled else 'disabled' }}">
                {{ motor.name }}
            </h2>
            <div class="btn-group">
                <button onclick="toggleTorque({{ motor.id }}, true)" class="btn btn-enable">Enable</button>
                <button onclick="toggleTorque({{ motor.id }}, false)" class="btn btn-disable">Disable</button>
            </div>
        </div>
        <div class="motor-stats">
            <div>Position: <span class="position-value" data-motor-id="{{ motor.id }}">{{ motor.position|default(0, true) }}</span>{% if motor.id == 2 %}mm{% else %}°{% endif %}</div>
            <div>Temperature: <span class="temperature-value">{{ motor.temperature }}</span>°C</div>
            <div>Voltage: <span class="voltage-value">{{ motor.voltage }}</span>V</div>
            <div>Current: <span class="current-value">{{ motor.current }}</span>A</div>
            <div>Velocity: <span class="speed-value">{{ motor.speed }}</span> ms</div>
            <div>Acceleration: <span class="load-value">{{ motor.load }}</span> ms</div>
            <div class="pid-info">
                <div class="position-pid" data-motor-id="{{ motor.id }}">
                    <span>Position PID:</span>
                    <span>P: {{ motor.position_pid.p }}, I: {{ motor.position_pid.i }}, D: {{ motor.position_pid.d }}</span>
                </div>
                <div class="velocity-pid" data-motor-id="{{ motor.id }}">
                    <span>Velocity PID:</span>
                    <span>P: {{ motor.velocity_pid.p }}, I: {{ motor.velocity_pid.i }}</span>
                </div>
            </div>
        </div>
        
        {% if motor.id in [3, 4] %}  {# Only for slider, pan, and tilt motors #}
        <div class="filter-status">
            <h3>Kalman Filter Status</h3>
            <div class="filter-stats">
                <div>
                    Prediction Time: 
                    <span class="prediction-time-value" data-motor-id="{{ motor.id }}">{{ motor.prediction_time|default(0.0, true)|round(3) }}</span> ms
                </div>
                <div>
                    Estimated Position: 
                    <span class="estimated-position" data-motor-id="{{ motor.id }}">{{ motor.estimated_position|default(0.0, true)|round(2) }}</span>
                    {% if motor.id == 2 %}mm{% else %}°{% endif %}
                </div>
                <div>
                    Estimated Velocity: 
                    <span class="estimated-velocity" data-motor-id="{{ motor.id }}">{{ motor.estimated_velocity|default(0.0, true)|round(2) }}</span>
                    {% if motor.id == 2 %}mm/s{% else %}°/s{% endif %}
                </div>
                <div>
                    Prediction Error: 
                    <span class="prediction-error" data-motor-id="{{ motor.id }}">{{ motor.prediction_error|default(0.0, true)|round(2) }}</span>
                </div>
                <div>
                    Filter Uncertainty: 
                    <span class="filter-uncertainty" data-motor-id="{{ motor.id }}">{{ motor.filter_uncertainty|default(0.0, true)|round(2) }}</span>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="motor-controls">
            <div class="control-group">
                <label for="position_{{ motor.id }}">Position ({% if motor.id == 2 %}mm{% else %}°{% endif %}):</label>
                <input type="number"
                       class="form-control"
                       id="position_{{ motor.id }}"
                       value="{{ motor.position }}"
                       min="{% if motor.id in [3, 4] %}-180{% elif motor.id == 2 %}0{% else %}0{% endif %}"
                       max="{% if motor.id in [3, 4] %}180{% elif motor.id == 2 %}800{% else %}360{% endif %}"
                       step="0.1">
                <button onclick="updateMotorPosition({{ motor.id }})" class="btn">Set</button>
            </div>

            <div class="control-group">
                <label for="velocity_{{ motor.id }}">Velocity (ms):</label>
                <input type="number"
                       class="form-control" 
                       id="velocity_{{ motor.id }}"
                       value="100"
                       min="0"
                       max="32000">
                <button onclick="updateMotorVelocity({{ motor.id }})" class="btn">Set</button>
            </div>

            <div class="control-group">
                <label for="acceleration_{{ motor.id }}">Acceleration (ms):</label>
                <input type="number"
                       class="form-control"
                       id="acceleration_{{ motor.id }}"
                       value="50"
                       min="0"
                       max="32000">
                <button onclick="updateMotorAcceleration({{ motor.id }})" class="btn">Set</button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<style>
.filter-status, .pid-info {
    background-color: #2a2a2a;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
}

.pid-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.position-pid, .velocity-pid {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9em;
}

.position-pid span:first-child,
.velocity-pid span:first-child {
    color: #bbb;
    font-weight: 500;
}

.position-pid span:last-child,
.velocity-pid span:last-child {
    color: #4a9eff;
    font-family: monospace;
}

.filter-status h3 {
    margin: 0 0 10px 0;
    color: #ddd;
    font-size: 1.1em;
}

.filter-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.filter-stats div {
    font-size: 0.9em;
    color: #bbb;
}

.filter-stats span {
    color: #4a9eff;
    font-weight: 500;
}

.prediction-error.warning {
    color: #ffbb00;
}

.prediction-error.error {
    color: #ff4444;
}

@keyframes value-update {
    0% { background-color: #4a9eff33; }
    100% { background-color: transparent; }
}

.value-updated {
    animation: value-update 0.5s ease-out;
}
</style>

{# prettier-ignore-start #}
<!-- Pass motor data to JavaScript -->
<script type="text/javascript">
(function() {
    // Safely pass motor data from server to client
    window.INITIAL_MOTOR_DATA = JSON.parse('{{ motors|tojson|safe }}');
})();
</script>
{# prettier-ignore-end #}

<!-- Load JavaScript modules -->
<script src="/static/motor_init.js"></script>
<script src="/static/main.js" defer></script>
<script src="/static/motor_status.js" defer></script>
{% endblock %}
